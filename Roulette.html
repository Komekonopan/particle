<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€ä¿®æ­£ç‰ˆã€‘è¢«ã‚‰ãªã„ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚²ãƒ¼ãƒ </title>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f3f4f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #111;
            margin-bottom: 10px;
        }
        .input-area {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        textarea {
            width: 200px;
            height: 100px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            resize: none;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            text-align: left;
        }
        #rouletteCanvas {
            background-color: #fff;
            border-radius: 50%;
            border: 5px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .controls {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            font-size: 16px;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #resultArea {
            margin-top: 15px;
            font-size: 1.1em;
            line-height: 1.6;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            width: 460px; /* Canvasã®å¹…ã¨åˆã‚ã›ã‚‹ */
            min-height: 80px;
            text-align: left;
        }
        #resultArea p {
            margin: 8px 0;
        }
    </style>
</head>
<body>

    <h1>è¢«ã‚‰ãªã„ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚²ãƒ¼ãƒ  (è‡ªç”±å…¥åŠ›ç‰ˆ)</h1>

    <div class="input-area">
        <div class="input-group">
            <label for="participantsInput">å‚åŠ è€… (1è¡Œã«1äºº)</label>
            <textarea id="participantsInput">Aã•ã‚“
Bã•ã‚“
Cã•ã‚“
Dã•ã‚“
Eã•ã‚“</textarea>
        </div>
        <div class="input-group">
            <label for="themesInput">ãŠé¡Œ (1è¡Œã«1ã¤)</label>
            <textarea id="themesInput">ãŠé¡Œï¼‘
ãŠé¡Œï¼’
ãŠé¡Œï¼“
ãŠé¡Œï¼”
ãŠé¡Œï¼•</textarea>
        </div>
        <div class="input-group">
            <button id="updateButton" style="margin-top: 25px;">ç›¤é¢ã‚’æ›´æ–°</button>
        </div>
    </div>
    
    <canvas id="rouletteCanvas" width="500" height="500"></canvas>
    
    <div class="controls">
        <button id="setupButton" disabled>ã‚²ãƒ¼ãƒ æº–å‚™ (çµæœã‚·ãƒ£ãƒƒãƒ•ãƒ«)</button>
        <button id="spinButton" disabled>æŠ½é¸ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div id="resultArea">
        <p>ã€Œç›¤é¢ã‚’æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€å…¥åŠ›å†…å®¹ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- ğŸ¨ è¨­å®š ---
            // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®æ‰‡å½¢ã®è‰²
            const COLORS = ['#FFD700', '#FF6B6B', '#4ECDC4', '#54A0FF', '#9B59B6', '#F0932B', '#EB4D4B', '#2ECC71', '#3498DB', '#E67E22'];
            // ------------------

            // --- DOMè¦ç´  ---
            const canvas = document.getElementById('rouletteCanvas');
            const ctx = canvas.getContext('2d');
            const participantsInput = document.getElementById('participantsInput');
            const themesInput = document.getElementById('themesInput');
            const updateButton = document.getElementById('updateButton');
            const setupButton = document.getElementById('setupButton');
            const spinButton = document.getElementById('spinButton');
            const resultArea = document.getElementById('resultArea');

            // --- å¤‰æ•° ---
            let participants = [];
            let themes = [];
            let numItems = 0;
            let mapping = []; // [å‚åŠ è€…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹] -> ãŠé¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ã®çµ„ã¿åˆã‚ã›
            let currentAngle = 0; // ç¾åœ¨ã®å›è»¢è§’åº¦ (ãƒ©ã‚¸ã‚¢ãƒ³)
            
            const PI2 = Math.PI * 2;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = canvas.width / 2 - 25; // çŸ¢å°ã®ãŸã‚ã«å°‘ã—å†…å´ã«

            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            updateButton.addEventListener('click', updateGameData);
            setupButton.addEventListener('click', setupGame);
            spinButton.addEventListener('click', startSpinning);

            /**
             * 1. å…¥åŠ›å€¤ã‚’å–å¾—ã—ã€ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
             */
            function updateGameData() {
                // æ”¹è¡Œã§åˆ†å‰²ã—ã€ç©ºè¡Œã‚’é™¤å»
                participants = participantsInput.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                themes = themesInput.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                numItems = participants.length;

                if (numItems === 0) {
                    resultArea.innerHTML = `<p style="color: red;">å‚åŠ è€…ã¾ãŸã¯ãŠé¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>`;
                    setupButton.disabled = true;
                    spinButton.disabled = true;
                    return;
                }

                if (numItems !== themes.length) {
                    resultArea.innerHTML = `<p style="color: red;">âš ï¸ å‚åŠ è€… (${numItems}äºº) ã¨ãŠé¡Œ (${themes.length}å€‹) ã®æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼</p>`;
                    setupButton.disabled = true;
                    spinButton.disabled = true;
                    return;
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒå–ã‚ŒãŸã‚‰ã€ç›¤é¢æç”»ã¨æº–å‚™ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                resultArea.innerHTML = `<p>ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†ï¼ (${numItems}äºº/${numItems}å€‹) ã€Œã‚²ãƒ¼ãƒ æº–å‚™ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>`;
                setupButton.disabled = false;
                spinButton.disabled = true;
                currentAngle = 0; // ç›¤é¢ã‚’ãƒªã‚»ãƒƒãƒˆ
                initialDraw();
            }
            
            /**
             * 2. ã‚²ãƒ¼ãƒ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆè¢«ã‚‰ãªã„çµ„ã¿åˆã‚ã›ã®ç”Ÿæˆï¼‰
             */
            function setupGame() {
                // äººæ•°ãŒå¤šã™ãã‚‹ã¨å®Œå…¨æ”ªä¹±ã®ç”ŸæˆãŒé›£ã—ããªã‚‹ãŸã‚ã€è­¦å‘Š
                if (numItems > 10) {
                    resultArea.innerHTML = `<p style="color: orange;">âš  å‚åŠ è€…ãŒå¤šã™ãã‚‹ã¨ã€Œè¢«ã‚‰ãªã„çµ„ã¿åˆã‚ã›ã€ã®ç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚‹ã‹å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>`;
                }

                mapping = createDerangement(numItems);
                if (!mapping) {
                    resultArea.innerHTML = `<p style="color: red;">ã‚¨ãƒ©ãƒ¼: è¢«ã‚‰ãªã„çµ„ã¿åˆã‚ã›ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>`;
                    return;
                }
                
                resultArea.innerHTML = "<p>æº–å‚™å®Œäº†ï¼ã€ŒæŠ½é¸ã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>";
                
                spinButton.disabled = false;
                setupButton.disabled = true; // æº–å‚™ã¯1å›ã ã‘
                updateButton.disabled = true; // æŠ½é¸ä¸­ã¯å¤‰æ›´ä¸å¯
            }
            
            /**
             * 3. å®Œå…¨æ”ªä¹±ï¼ˆi != array[i]ï¼‰ã®é…åˆ—ã‚’ç”Ÿæˆ
             */
            function createDerangement(n) {
                let arr = Array.from({length: n}, (_, i) => i);
                let attempts = 0;
                
                while (attempts < 10000) { // è©¦è¡Œå›æ•°ã‚’å¤§å¹…ã«å¢—ã‚„ã™
                    // Fisher-Yates ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                    for (let i = arr.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [arr[i], arr[j]] = [arr[j], arr[i]];
                    }
                    
                    // è¢«ã‚ŠãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
                    let isDerangement = true;
                    for (let i = 0; i < n; i++) {
                        if (arr[i] === i) {
                            isDerangement = false;
                            break;
                        }
                    }
                    
                    if (isDerangement) {
                        return arr; // æˆåŠŸ
                    }
                    attempts++;
                }
                
                console.warn("å®Œå…¨æ”ªä¹±ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                return null; // å¤±æ•—
            }

            /**
             * 4. ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç›¤é¢ã‚’æç”»
             */
            function drawRoulette(angle) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (numItems === 0) return;
                
                const arcSize = PI2 / numItems; // 1åŒºç”»ã®è§’åº¦

                for (let i = 0; i < numItems; i++) {
                    ctx.beginPath();
                    const startAngle = angle + i * arcSize;
                    const endAngle = startAngle + arcSize;
                    
                    // æ‰‡å½¢ã‚’æç”»
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    ctx.closePath();
                    
                    ctx.fillStyle = COLORS[i % COLORS.length];
                    ctx.fill();
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãŠé¡Œï¼‰ã‚’æç”»
                    ctx.save();
                    ctx.fillStyle = 'black';
                    ctx.font = 'bold 16px sans-serif';
                    ctx.translate(centerX, centerY);
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆã®è§’åº¦ã‚’æ‰‡å½¢ã®ä¸­å¤®ã«
                    const textAngle = startAngle + arcSize / 2;
                    ctx.rotate(textAngle);
                    
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    // å††ã®å¤–å´ã‚’å‘ãã‚ˆã†ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’é…ç½®
                    ctx.fillText(themes[i], radius * 0.7, 0);
                    ctx.restore();
                }
            }

            /**
             * 5. çŸ¢å°ã‚’æç”» (å¸¸ã«å›ºå®š)
             */
            function drawArrow() {
                // çŸ¢å°
                ctx.fillStyle = '#E74C3C'; // ç›®ç«‹ã¤èµ¤è‰²
                ctx.beginPath();
                // çŸ¢å°ã®å…ˆç«¯ã‚’ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç›¤ã®çœŸä¸Šã«
                ctx.moveTo(centerX, centerY - radius - 20);
                ctx.lineTo(centerX - 12, centerY - radius - 5);
                ctx.lineTo(centerX + 12, centerY - radius - 5);
                ctx.closePath();
                ctx.fill();
                
                // è»¸
                ctx.beginPath();
                ctx.arc(centerX, centerY, 10, 0, PI2);
                ctx.fillStyle = '#555';
                ctx.fill();
            }

            /**
             * 6. æŠ½é¸ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆä¸€äººãšã¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
             */
            async function startSpinning() {
                spinButton.disabled = true;
                updateButton.disabled = true;
                resultArea.innerHTML = ""; // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
                
                for (let i = 0; i < numItems; i++) {
                    const participant = participants[i];
                    // å‚åŠ è€…iãŒå½“ãŸã‚‹ã¹ããŠé¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                    const targetThemeIndex = mapping[i]; 
                    const targetTheme = themes[targetThemeIndex];
                    
                    resultArea.innerHTML += `<p><strong>${participant}</strong> ã®ç•ªã§ã™... </p>`;
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                    await animateSpin(targetThemeIndex);
                    
                    // çµæœã‚’ç¢ºå®šã—ã¦è¡¨ç¤º
                    const resultP = resultArea.querySelector('p:last-child');
                    resultP.innerHTML = `âœ… <strong>${participant}</strong> ã¯ <strong>${targetTheme}</strong> ã«æ±ºå®šï¼`;
                    
                    await sleep(1500); // æ¬¡ã®äººã¾ã§ã®å¾…æ©Ÿæ™‚é–“
                }
                
                resultArea.innerHTML += "<h3>å…¨å“¡ã®æŠ½é¸ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>";
                setupButton.disabled = false; // å†åº¦æº–å‚™ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                updateButton.disabled = false;
            }

            /**
             * 7. 1å›åˆ†ã®ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè§’åº¦ä¿®æ­£æ¸ˆã¿ï¼‰
             */
            function animateSpin(targetIndex) {
                return new Promise(resolve => {
                    const arcSize = PI2 / numItems;
                    
                    // --- ğŸ¯ åœæ­¢ç›®æ¨™è§’åº¦ã®è¨ˆç®— (é‡è¦) ---
                    // çŸ¢å°ã¯ä¸Šå‘ã(Yè»¸ãƒã‚¤ãƒŠã‚¹æ–¹å‘)ã€‚canvasåº§æ¨™ç³»ã§ã¯ã€çœŸä¸ŠãŒ -PI/2 ã§ã™ã€‚
                    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ‰‡å½¢ã®ä¸­å¤®ãŒ -PI/2 ã«æ¥ã‚‹ã‚ˆã†ã«è§’åº¦ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
                    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚»ã‚¯ã‚¿ãƒ¼ã®è§’åº¦: [targetIndex * arcSize, (targetIndex + 1) * arcSize]
                    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚»ã‚¯ã‚¿ãƒ¼ã®ä¸­å¤®: targetIndex * arcSize + arcSize / 2
                    
                    // å›è»¢å¾Œã®è§’åº¦ã‚’0ã¨ã—ã¦ã€ãã“ã‹ã‚‰é€†ç®—ã—ã¦å¿…è¦ãªå›è»¢è§’åº¦ã‚’æ±‚ã‚ã¾ã™ã€‚
                    // çœŸä¸ŠãŒ0åº¦ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¾ã™ã€‚ï¼ˆæç”»é–¢æ•°ã®ä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
                    let targetSectorCenter = targetIndex * arcSize + arcSize / 2;
                    let angleToCenter = PI2 - targetSectorCenter; // ä¸­å¤®ã‚’çœŸä¸‹ï¼ˆPI/2ï¼‰ã‹ã‚‰çœŸä¸Šï¼ˆ-PI/2ï¼‰ã¸ç§»å‹•ã•ã›ã‚‹
                    
                    // åœæ­¢è§’åº¦ã«ãƒ©ãƒ³ãƒ€ãƒ ãªã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¿½åŠ ï¼ˆè¦‹ãŸç›®ã®ãƒ©ãƒ³ãƒ€ãƒ æ€§ï¼‰
                    angleToCenter += (Math.random() * 0.4 - 0.2) * arcSize; // ã‚»ã‚¯ã‚¿ãƒ¼å†…ã§å¾®èª¿æ•´
                    
                    // æœ€ä½ã§ã‚‚5å›è»¢ã¯ã•ã›ã‚‹
                    const minRotations = 5;
                    const finalAngle = angleToCenter + PI2 * minRotations;
                    
                    const duration = 5000; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ (5ç§’)
                    const startTime = performance.now();
                    const startAngle = currentAngle; // å‰å›ã®åœæ­¢ä½ç½®ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ

                    // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é–¢æ•° (ã ã‚“ã ã‚“é…ããªã‚‹)
                    function easeOutQuart(t) {
                        return 1 - (--t) * t * t * t;
                    }

                    function animate(currentTime) {
                        const elapsedTime = currentTime - startTime;
                        let t = elapsedTime / duration;
                        
                        if (t >= 1.0) t = 1.0;
                        
                        const easedT = easeOutQuart(t);
                        
                        // ç¾åœ¨ã®è§’åº¦ã‚’è¨ˆç®—
                        currentAngle = startAngle + (finalAngle - startAngle) * easedT;
                        
                        drawRoulette(currentAngle);
                        drawArrow();

                        if (t < 1.0) {
                            requestAnimationFrame(animate);
                        } else {
                            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
                            currentAngle = finalAngle % PI2; // æœ€çµ‚è§’åº¦ã‚’0ã€œ2PIã®é–“ã«æ­£è¦åŒ–ã—ã¦ä¿æŒ
                            resolve();
                        }
                    }
                    
                    requestAnimationFrame(animate);
                });
            }
            
            /**
             * å¾…æ©Ÿç”¨é–¢æ•°
             */
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // --- åˆæœŸåŒ–å‡¦ç† ---
            updateGameData(); // èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å…¥åŠ›å€¤ã§ä¸€åº¦æ›´æ–°ãƒ»æç”»
            
            function initialDraw() {
                drawRoulette(currentAngle); 
                drawArrow();
            }
        });
    </script>

</body>
</html>
